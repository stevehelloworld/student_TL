# 學生出勤系統業務流程

## 1. 使用者登入與權限驗證
- 使用者（管理員/老師/學生）透過 `/api/auth/login` 登入，取得 JWT Token。
- 前端於後續 API 請求中帶入 Token，後端驗證權限與身分。
- 家長可使用學生的帳號登入，存取被授權的資訊。

## 2. 使用者管理
- 所有使用者帳號由管理員統一建立，包含以下角色：
  - 管理員：系統管理人員
  - 教師：授課教師
  - 學生：課程學員
- 帳號建立流程：
  1. 管理員填寫使用者基本資料（姓名、角色、聯絡方式等）
  2. 系統自動產生初始密碼
  3. 帳號初始狀態為「待啟用」
  4. 管理員可選擇透過電子郵件或簡訊發送帳號開通通知
  5. 使用者首次登入時需變更密碼
- 帳號狀態管理：
  - 待啟用（pending）：新建立帳號，尚未啟用
  - 啟用中（active）：帳號正常使用中
  - 停用中（inactive）：暫時停用帳號
  - 已停權（suspended）：因違規被停權
- 學生家長資料管理：
  - 由管理員為學生建立家長資料
  - 一個學生可設定多位家長
  - 需指定一位主要聯絡人
  - 家長資料包含：姓名、關係、聯絡方式等
  - 系統通知將發送至主要聯絡人的聯絡方式

## 3. 班級與課程管理
- 系統建立班級（如：程式思維班、英文會話班等），每個班級可包含多個相同進度的課程。
- 班級基本資訊：
  - 班級名稱、學年度、學期
  - 班級導師
  - 所屬課程時段
  - 班級狀態
- 課程管理：
  - 每個課程隸屬於一個班級
  - 設定上課時段（如：週四晚上、週六早上、週日下午）
  - 課程基本資訊：
    - 上課時段（每週固定時間）
    - 上課地點
    - 對應場次
    - 課程狀態（草稿、已發布、進行中、已完成、已取消）
- 學生分班：
  - 批次匯入/匯出學生名單
  - 調整學生班級
  - 管理班級課表。

## 4. 學生選課
- 學生可被 管理員/老師 加入課程（enrollments）。
- 避免重複選課（課程ID、學生ID唯一）。
- 選課狀態包含：已註冊、待繳費、已取消。

## 5. 課程上課場次（sessions）
- 課程對應多個上課場次（session），每場次有日期、起訖時間、地點。
- 場次教師安排：
  - 每個場次可指定主要授課教師
  - 可設定代課教師（當主要教師請假時）
  - 系統會檢查教師時間衝突
  - 自動計算教師授課時數
- 出勤管理：
  - 管理員/老師可為每場次標記學生出勤狀態（已到、遲到、早退、缺課、請假）
  - 系統自動計算學生的出勤率
  - 提供教師出勤記錄查詢

## 6. 出勤紀錄管理
- 管理員/老師可批次標記多位學生的出勤狀態。
- 可查詢每堂課所有學生出勤紀錄，並可匯出報表（如CSV、PDF）。
- 學生可查詢個人所有課程出勤紀錄，並可依日期、課程名稱篩選。
- 家長可查詢子女的出勤紀錄。

## 7. 請假申請與管理
- 學生可申請事假/病假，需於上課前1小時提出，無需老師審核。
- 家長可代為學生提出請假申請。
- 請假申請可於上課前取消。
- 管理員/老師可隨時為學生登記、修改或刪除請假（不受申請截止時間限制）。
- 系統自動記錄請假時數，並更新學生請假統計。

## 8. 補課安排與紀錄
- 管理員/老師可為請假學生安排補課，並記錄補課出席狀態。
- 學生可查詢自己的補課安排與出席狀態。
- 家長可查詢子女的補課安排與出席狀態。
- 管理員/老師 可查詢指定學生的補課安排與出席狀態。

## 9. 通知系統
### 9.1 通知類型
- 出勤狀態變更通知
- 請假申請/審核通知
- 補課安排通知
- 課程異動通知
- 系統公告

### 9.2 通知方式
- 站內信
- 電子郵件
- Line 官方帳號
- 簡訊（可選）

### 9.3 通知設定
- 個人化通知偏好設定
- 通知時段設定
- 緊急通知覆蓋設定
- 通知範本管理

### 9.4 通知追蹤
- 已讀/未讀狀態
- 通知歷程記錄
- 通知統計報表

## 10. 系統資料流
1. 前端登入取得 Token。
2. 前端帶 Token 呼叫 API 取得/更新資料。
3. 後端驗證 Token，執行資料存取與業務邏輯。
4. 觸發相關事件（如：出勤更新、請假申請等）。
5. 發送相應通知。
6. 回傳結果給前端顯示。

## 11. 主要資料表關聯
### 11.1 核心資料表
- `class_groups`（班級）1:N `courses`（課程）
- `courses`（課程）1:N `sessions`（場次）
- `users`（使用者）1:N `enrollments`（註冊記錄）
- `enrollments`（註冊記錄）1:1 `course_enrollments`（課程註冊）
- `users`（學生）1:N `class_enrollments`（班級註冊）
- `class_enrollments`（班級註冊）1:1 `primary_course`（主要課程）

### 11.2 出勤與請假
- `sessions`（場次）1:N `attendance_records`（出勤紀錄）
- `sessions`（場次）1:N `leave_requests`（請假申請）
- `leave_requests`（請假申請）1:1 `make_up_sessions`（補課安排）
- `leave_requests`（請假申請）1:1 `switched_session`（調課場次）

### 11.3 使用者關聯
- `users`（使用者）1:N `parents`（家長）
- `parents`（家長）1:N `student_parents`（學生家長關聯）
- `users`（學生）1:N `student_parents`（學生家長關聯）
- `users`（學生）1:1 `student_leave_stats`（學生請假統計）
- `users`（學生）1:1 `student_attendance_stats`（學生出勤統計）

### 11.4 通知與公告
- `users`（使用者）1:N `notifications`（系統通知）
- `notifications` 1:N `notification_logs`（通知發送記錄）
- `sessions`（場次）1:N `session_materials`（課程教材）
- `courses`（課程）1:N `course_announcements`（課程公告）
- `class_groups`（班級）1:N `class_announcements`（班級公告）

### 11.5 系統設定
- `system_settings`（系統設定）
- `notification_templates`（通知範本）
- `report_templates`（報表範本）
- `audit_logs`（操作日誌）

